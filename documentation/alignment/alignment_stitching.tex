\documentclass{article}

\usepackage{amsmath}
\usepackage{multicol}
\usepackage{graphicx}
\usepackage[subrefformat=simple,labelformat=simple]{subcaption}
\usepackage{hyperref}
\usepackage{cleveref}
\renewcommand\thesubfigure{(\alph{subfigure})}

\newcommand{\pvec}[1]{{\vec{#1}\mkern2mu\vphantom{#1}}^\prime}
\newcommand{\matrixbold}[1]{\mathbf{#1}}

\begin{document}
	
\title{Alignment and stitching of microscope images}
\author{Heshy Roskes}
\date{March 18, 2020}

\section{Introduction}

Our microscope is supposed to scan a tissue sample, which covers some subset of a slide of size $L\times W$.  Initially, it performs a quick scan of the whole slide with a small magnification setting.  This scan is recorded in \texttt{qptiff} format.

Using that image, the microscope determines which parts of the slide actually have tissue in them.  It scans those sections under a larger magnification, using fields of size $l\times w$.  Covering the whole tissue may require $O(1000)$ fields.

The scanning is configured with an overlap fraction $f=20\%$, so that some parts of the image are scanned twice.  The rightmost $\frac{1}{2}fl$ of each field overlaps the leftmost $\frac{1}{2}fl$ of the field to its right.  Similarly, the bottom $\frac{1}{2}fw$ of each field overlaps with the top $\frac{1}{2}fw$ of the field under it.  These overlaps are used to assess differences between the fields, to correct those differences, and ultimately to assess systematic uncertainties based on the remaining differences.

In the process of scanning, the microscope moves from one field to the next.   The slide is supposed to move horizontally by $l(1-f)$ and vertically by $w(1-f)$.  In practice, due to mechanical imprecisions in the microscope, the slide does not always move by exactly this amount, and so a simple, out of the box tiling of the fields (even taking the overlap regions into account by shaving off the outer $\frac{1}{2}fl$ and $\frac{1}{2}fw$ from each side) does not give an accurate picture of the tissue sample.  If fields move away from each other, cells in the boundary region will appear larger than they should due to duplicated pixels, and in extreme cases they may even be cut in half.  If they move towards each other, those cells will appear \emph{smaller} than they should, and for an extreme shift small cells might be completely gone.  If they move sideways, the cell's shape might be ruined and it may not be identified properly.

Here, we describe how we measure the actual positions of the fields based on the images themselves.

\section{Alignment model}

We allow for two sources of error in the microscope's positioning.
\begin{enumerate}
\item When the controlling computer signals the microscope to move by $\Delta \vec{r}=(\Delta x, \Delta y)$, imperfect calibration may result in an actual movement of $\matrixbold{A}\Delta\vec{r}$, where $\matrixbold{A}$ is a $2\times2$ matrix to be measured from the data.
\item Each movement of the microscope involves a random error, so that the final, actual movement is $\matrixbold{A}\Delta\vec{r}+\delta\vec{r}$.
\end{enumerate}
Our alignment procedure measures and corrects for both sources of error simultaneously.  The final output is the matrix $A$ and the real position $\vec{r}_i$ of each field $i$.

\section{Alignment procedure}

The first step is to look at each pair of overlapping fields and measure the relative shift of those two fields.  Once we assemble all of those results, we stitch them together to obtain the final result.

\subsection{Pairwise alignment}
\label{sec:pairwise}

For any individual pair of fields that overlap, we can align those two fields by comparing the images to each other.  For example, \cref{fig:overlapbefore} shows the overlap of two fields connected by a corner.  It is clear that the two fields are misaligned and that the field shown in green needs to move up and to the right with respect to the pink field.  The result, with the size and direction of the shift determined using the procedure described below, is shown in \cref{fig:overlapafter} and indicates much better agreement between the fields.

\begin{figure}[ht]
	\centering
	\begin{subfigure}{0.45\linewidth}
	\includegraphics[width=\linewidth]{overlap-notshifted.pdf}
	\caption{}
	\label{fig:overlapbefore}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
	\includegraphics[width=\linewidth]{overlap-shifted.pdf}
	\caption{}
	\label{fig:overlapafter}
	\end{subfigure}
	\caption{The overlap of two fields \subref{fig:overlapbefore} before and \subref{fig:overlapafter} after alignment.  The two fields' images are shown in pink and green, respectively.  Because those colors are complementary, gray areas mean that the two fields have the same intensity in that spot.}
	\label{fig:overlap}
\end{figure}

In order to determine the size and direction of the shift, we compute the \emph{cross correlation} between the two overlap images.  The cross correlation $C$ between images $A$ and $B$ is defined as
\begin{equation}
C(\delta\vec{r})=(A\star B)(\delta\vec{r})\equiv\sum_{\vec{r}} {A(\vec{r})B(\vec{r}+\delta\vec{r})}
\label{eq:xcorrelation}
\end{equation}
and describes how similar the two images are when shifted by $\delta\vec{r}$ with respect to each other.  The value of $d\vec{r}$ that maximizes $C$ gives the optimal shift.  We want to achieve precision better than a single pixel, so we fit the region around the tallest peak of the cross-correlation function to a cubic polynominal and find its maximum $\delta\vec{r}_\text{max}$, as shown in \cref{fig:1Dmaximizationplot} for a one-dimensional example.  For the real images, we fit the region around the peak to a two-dimensional cubic polynomial.

\begin{figure}[ht]
	\centering
	\begin{subfigure}{0.45\linewidth}
	\includegraphics[width=\linewidth]{overlap-xcorrelation.pdf}
	\caption{}
	\label{fig:xcorrelation}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
	\includegraphics[width=\linewidth]{1Dmaximization.pdf}
	\caption{}
	\label{fig:1Dmaximizationplot}
	\end{subfigure}
	\caption{
		\subref{fig:xcorrelation} Plot of the cross-correlation function for the overlap shown in \cref{fig:overlap}.
		\subref{fig:1Dmaximizationplot} Example of the procedure for aligning two images to sub-pixel precision.  The blue points show the cross correlation function for pixel shifts, calculated using \cref{eq:xcorrelation}.  The blue curve shows a polynomial fit to the cross correlation function, and the orange point and line show the maximum of the polynomial fit.
	}
	\label{fig:1Dmaximization}
\end{figure}

\subsection{Uncertainty on pairwise alignment}

We also want to estimate the uncertainty on $\delta\vec{r}$.  This will become important in the next step, when we want to combine all of the alignment results and assign a larger weight to alignments with smaller uncertainty.  To obtain this uncertainty, we first estimate $\sigma_C(\delta\vec{r}_\text{max})$, the uncertainty on the value of the cross correlation function at its maximum.  We shift the images by $\pm0.5\delta\vec{r}_\text{max}$, so that they are now in their best-aligned position (as shown in \cref{fig:overlapafter}).  We can call the shifted images
\begin{align}
\begin{aligned}
A^\prime(\vec{r})&=A\left(\vec{r}-\frac{1}{2}\delta\vec{r}_\text{max}\right), \\
B^\prime(\vec{r})&=B\left(\vec{r}+\frac{1}{2}\delta\vec{r}_\text{max}\right).
\end{aligned}
\end{align}
Plugging into \cref{eq:xcorrelation},
\begin{align}
\begin{aligned}
C(\delta\vec{r}_\text{max})&=\sum_{\vec{r}}A^\prime\left(\vec{r}+\frac{1}{2}\delta\vec{r}_\text{max}\right) B\left(\vec{r}+\frac{1}{2}\delta\vec{r}_\text{max}\right) \\
&=(A^\prime\star B^\prime)(0)
\end{aligned}
\end{align}

At this point, we consider that the two images are as well aligned as we can make them, and are supposed to be two independent measurements of the same thing.  We then estimate the error on an individual pixel's intensity, in either $A^\prime$ or $B^\prime$, as
\begin{equation}
\sigma_{A^\prime}(\vec{r})=\sigma_{B^\prime}(\vec{r})=\left|A^\prime(\vec{r})-B^\prime(\vec{r})\right|.
\label{eq:pixelerror}
\end{equation}

By standard techniques of error propagation, we then derive
\begin{align}
\begin{aligned}
\sigma_C(\delta\vec{r}_\text{max})&=\sum_{\vec{r}}\left(\left[A^\prime(\vec{r})\sigma_{B^\prime}(\vec{r})\right]^2+\left[\sigma_{A^\prime}(\vec{r})B^\prime(\vec{r})\right]^2\right) \\
&=([(A^\prime)^2+(B^\prime)^2]\star\sigma_{A^\prime,B^\prime}^2)(0)
\end{aligned}
\end{align}

\begin{figure}[ht]
	\centering
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{1Dmaximizationwitherror.pdf}
%		\caption{}
%		\label{fig:1Dmaximizationploterror}
	\end{subfigure}
	\caption{Illustration of the procedure for error estimation using the same example curve as in \cref{fig:1Dmaximizationplot}.  Given the error on $C$ at the peak, $\sigma_C$, shown in orange, we can use the second derivative of the curve to estimate the error on $x_\text{max}$, $\sigma_\text{xmax}$, shown in pink.}
	\label{fig:1Dmaximizationploterror}
\end{figure}

We now use $\sigma_C(\delta\vec{r}_\text{max})$ to derive $\sigma_{\delta\vec{r}_\text{max}}$.  To motivate the calculation, we first consider the 1-dimensional case shown in \cref{fig:1Dmaximizationploterror}.  As illustrated there, we need to find $\sigma_{\delta x_\text{max}}$ so that $C(\delta x_\text{max}\pm\sigma_{\delta x_\text{max}})=C(\delta x_\text{max})-\sigma_C$.  Assuming $\delta x$ is small, we can do this by expanding
\begin{equation}
C(\delta x)\approx\delta x_\text{max} + \frac{1}{2}C''(\delta x_\text{max})(\delta x - \delta x_\text{max})^2
\end{equation}
and find that
\begin{equation}
\sigma_{\delta x_\text{max}}^2=\frac{2\sigma_C(\delta x_\text{max})}{C''(\delta x_\text{max})}.
\end{equation}

By an analogous argument, we find the equivalent result in the two-dimensional case.  Beause $\delta\vec{r}$ has two components, $\delta x$ and $\delta y$, we have a $2\times2$ covariance matrix,
\begin{equation}
\matrixbold{cov}_{\delta\vec{r}_\text{max}}=2\sigma_C(\delta\vec{r}_\text{max})\matrixbold{H}^{-1}(\delta\vec{r}_\text{max}),
\end{equation}
where $ %\begin{equation}
\matrixbold{H}=\begin{pmatrix}
\frac{\partial^2C}{\partial \delta x^2} & \frac{\partial^2C}{\partial \delta x \partial \delta y} \\
\frac{\partial^2C}{\partial \delta x \partial \delta y} & \frac{\partial^2C}{\partial \delta y^2}
\end{pmatrix}
$ %\end{equation}
is the Hessian matrix of $C(\delta\vec{r})$.

For the final step, we multiply the covariance matrix by a factor determined empirically, as we will describe in \cref{sec:pulls}.  This factor is found to be $\frac{1}{16}$, which means that the original error estimate was too conservative by a factor of $4$.  One possibility for this overestimate is that, if the alignment is not perfect, \cref{eq:pixelerror} overestimates the error on pixel intensity in regions where cell boundaries do not line up correctly.  Whatever the explanation, the plots in \cref{sec:pulls} will show that the corrected covariance matrix
\begin{equation}
\matrixbold{cov}_{\delta\vec{r}_\text{max}}^\text{corr}=\frac{1}{2}\sigma_C(\delta\vec{r}_\text{max})\matrixbold{H}^{-1}(\delta\vec{r}_\text{max})
\end{equation}
is a good estimate of our uncertainty.

\subsection{Detecting bad overlaps}

The error estimation procedure also gives us an opportunity to detect when a particular overlap does not contain enough information to align it.  This happens when the overlap region does not contain any cells, and sometimes also when it contains one or two.  In this case, the cross correlation function simply consists of noise.

The procedure in \cref{sec:pairwise} looks at the tallest peak of 

As an automated way to detect bad overlaps, we look at all 

\subsection{Pull distributions}
\label{sec:pulls}

\end{document}