%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PREAMBLE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%environment setup
\documentclass[letterpaper,11pt]{article}
\usepackage[square,comma,numbers,sort&compress]{natbib}
\bibliographystyle{ieeetr}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{url}
\usepackage{xspace}
\usepackage[left=20mm,top=20mm]{geometry}
\usepackage{hyperref}
\usepackage{lineno}
\renewcommand{\familydefault}{\sfdefault}

%macros
\newcommand{\reffig}[1]{Figure~\ref{#1}}
\newcommand{\refsec}[1]{Section~\ref{#1}}
\newcommand{\refeq}[1]{Equation~\ref{#1}}
\DeclareMathOperator*{\argmax}{arg\,max}
\newcommand{\Tau}{\mathrm{T}}
\newcommand{\Iota}{\mathrm{I}}
\newcommand{\Mu}{\mathrm{M}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% TITLE AND ABSTRACT %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%title
\title{Flatfielding: Spatially-Dependent Correction of Microscope High-power Field Illumination}
\author{Maggie Eminizer\\ \url{margaret.eminizer@gmail.com}\\ JHU Astropath Group}
\date{\today}
\begin{document}
\maketitle

%start numbering lines
\linenumbers

%abstract
\abstract{This note details a method for correcting systematic variations in the illumination of multiplexed immunofluorescence microscopy images. The variations are measured using regions of image layers that are free of empty background as determined using a thresholding and masking procedure. The illumination flux observed in these regions is averaged over a large number of images, and the resulting variation pattern is smoothed to retain only the large-scale effects. The spatially-dependent corrections are defined as the ratios of these average flux patterns to their mean values in each image layer. The effect of applying these corrections is characterized using a set of 45,384 melanoma tissue images collected at the Johns Hopkins Hospital using an Akoya Biosciences Vectra 3.0 digital microscope. It is shown that the illumination of the tissue depicted in these images initially varies with an average standard deviation of 4.2\% relative flux in systematic patterns for each image layer, and that applying the corrections reduces the variation to an average standard deviation of 1.0\% relative flux in more random patterns.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% INTRODUCTION SECTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:introduction}

The Astropath group's work in quantifying patient outcomes from cancer immunotherapies is largely driven by analysis of multiplexed immunofluorescence microscopy images. As the group maintains focus on scaling up to curate and analyze large datasets representing multiple types of cancers contributed by a variety of primary sources or collaborators, a major push continues to be performing as much of that image analysis as possible in an automated fashion. It is therefore imperative that the image data themselves are of a very high quality, corrected for subtle effects that may adversely impact how individual images are related to one another to represent an entire microscope slide, or how the contents of those slides may be identified by automated algorithms as cells expressing certain immunofluorescence markers of interest. This note discusses a method developed to perform a low-level initial correction to the illumination of raw microscope images, and details the effect of applying this correction to an example dataset. 

%%%%%%%%%%% Flatfielding in general subsection
\subsection{Flatfielding in general}
\label{ssec:flatfielding_in_general}

The microscopes used in the Astropath group's analyses all collect light reflected off a sample illuminated by an external light source. Nonuniformities in the microscope optical path and other aspects of the methods by which slides are illuminated inherently introduce a type of systematic noise that appears as variations in the amount of illumination flux recorded at certain points in each collected image. These effects, which make some image regions brighter on average than others, tend to be especially pronounced at the edges of images, and are known interchangeably by terms including ``intensity nonuniformity,'' ``uneven shading,'' ``vignetting,'' or simply ``illumination variation'' \cite{doi:10.1111/jmi.12178}. The term ``flat field correction'' (or ``flatfielding'') refers to procedures designed to minimize these systematic illumination variations as they appear in high-power field (HPF) fluorescence microscopy images. 

Although the effects of uneven illumination may barely be noticeable within single images or during qualitative image analysis, they become much more problematic when large groups of images are analyzed, or when highly quantitative analysis depending entirely on pixel illumination flux content is performed. The Astropath group's procedure for aligning and stitching single HPF images together to represent a single high-magnification image of an entire slide is an example of such a flux-dependent quantitative analysis that would be adversely affected by certain regions of HPF images being brighter in general than others \cite{Heshy}. Other methods currently in development for automated segmentation of cells and quantitative pathology will also likewise depend on reliable measurements of illumination flux.

Methods for correction of the type of illumination variation in question have long existed, and are often built into digital microscopy image analysis platforms like CellProfiler \cite{Carpenter2006}, or even directly into automated microscope imaging procedures. These correction methods can generally be separated into the two categories of ``a-priori,'' referring to corrections derived from calibration materials imaged through the same methods as the samples of interest, and ``a-posteriori,'' referring to corrections determined only from the images of interest themselves \cite{18770694}. A-priori methods are particularly limited in effectiveness for applications in digital, high-throughput, fluorescence microscopy, because they require time and infrastructue investment in additional imaging of reference samples, the reference samples themselves can be nontrivial to prepare such that they fluoresce identically to biological samples, and because additional digital noise beyond optical effects may impact illumination variation \cite{doi:10.1111/jmi.12178}.

A-posteriori methods have therefore been developed using a variety of approaches in the 21st century, including modeling additive and multiplicative noise components and fitting the model to data by minimizing the entropy of the corrected image \cite{PMID:10692132} or filtering images for low-frequency illumination variations and correcting the pattern observed at this frequency \cite{Leong619}. Authors have also made important distinctions between illumination variation affecting slides as a whole as opposed to just the tissue or cells within an image \cite{Carpenter2006}. The method the Astropath group has developed is a-posteriori by design, and uses large samples of images of interest to measure and correct large-scale illumination variation within these images' tissue regions. The advantages of this approach are that no additional imaging of calibration samples is necessary, and that the measured corrections are unbiased to regions of images that show only background and not the tissue used for pathological analysis.

%%%%%%%%%%% Work already performed subsection
\subsection{Work already performed}
\label{ssec:work_already_performed}

The Astropath group's investigations of systematic illumination variation effects began in 2017, when substantial effects were noticed in Tissue Microarray (TMA) and deep tissue microscope images. In the first version of the work, documented in \cite{Alex_flatfielding_1}, an a-priori method was used to model the effects, wherein a slide of light diffusing material was imaged using identical methods to the slides of interest. The composite image layers, unmixed from their initial component layers, were normalized by their mean illumination flux, resulting in the pattern shown on the upper left-hand side of \reffig{fig:first_flatfielding} for the DAPI layer of the unmixed image. This pattern was fit with a two-dimensional, second degree polynomial function, shown on the upper right-hand side of \reffig{fig:first_flatfielding}. The flux at each pixel in the first layer of the full individual component IM3 image was then divided by the associated value of the function fitted to the unmixed DAPI layer, and a resulting decrease in the systematic illumination variation was observed, as shown in the lower plot in \reffig{fig:first_flatfielding}. Similar methods using a third-degree polynomial fit were applied to the other layers of the unmixed images, as well as the individual component IM3 layers, with varying results. It was concluded that a polynomial fit was likely insufficient to describe the illumination variations in all image layers.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.45\textwidth]{images/introduction/first_unmixed_DAPI_meanimage}
\includegraphics[width=0.45\textwidth]{images/introduction/first_DAPI_meanimage_polynomial_fit}
\includegraphics[width=0.45\textwidth]{images/introduction/first_DAPI_meanimage_corrected_flux}
\caption{\footnotesize Upper left: Illumination flux pattern observed in the unmixed DAPI layer of an imaged light diffuser. Upper right: Two-dimensional, second-degree polynomial fitted to the mean-normalized flux pattern pictured in the upper left figure. Lower: Histogram of log pixel counts vs. mean-normalized flux for the light diffuser image's unmixed DAPI layer (in red), first component IM3 layer (in blue), and first component IM3 layer after pixelwise division by the polynomial shown in the upper right plot (in green); the applied correction has reduced the systematic illumination variation to more Gaussian noise. Figures from \cite{Alex_flatfielding_1}.}
\label{fig:first_flatfielding}
\end{figure}

After these initial investigations, the decision was made to correct illumination variations in images in the raw IM3 component layers rather than in the unmixed composite image layers, and a new a-posteriori method was devloped to model the effects, as documented in \cite{Alex_flatfielding_2}. In this method, the flatfielding corrections were determined by making a single, multi-layer, average raw image from a set of 7,358 HPFs, smoothing the layers of the mean image with a Gaussian filter of standard deviation $\sigma=100$ pixels to retain only the large-scale pattern, and dividing this smoothed mean image by the mean average flux value layer-by-layer so that the corrections did not change the overall illumination of each image layer. It was found that this method resulted in consistent illumination variation patterns, shown in \reffig{fig:second_flatfielding}, correlated within layers contributing to the same broadband filter region (raw layers 1-9, 10-18, 19-25, 26-32, and 33-35 for the DAPI, FITC, Cy3, Texas Red, and Cy5 unmixed spectral components, respectively).

\begin{figure}[!ht]
\centering
\includegraphics[width=0.8\textwidth]{images/introduction/second_flatfield_image_layers}
\caption{\footnotesize Selected layers of the flatfield image from \cite{Alex_flatfielding_2}, stretched from minimum to maximum mean-normalized flux, in the first, middle, and last layer of each broadband filter region as labeled. The patterns are fairly consistent between each broadband filter break. Layer 26, the first layer in the Texas Red region, was not brightly illuminated for the melanoma tissue samples used, and represents an outlier in this and other investigations.}
\label{fig:second_flatfielding}
\end{figure}

After using this new model for some time to correct HPF illumination, it was discovered \cite{Ben_flatfielding_1} that the algorithm implemented in the inForm software package \cite{Kramer2018} used to phenotype cells for pathology was over-identifying cells of a certain type in some more recently-collected samples, in a pattern similar to that of the original flatfield correction images. Updated flatfield correction models were developed using the same averaging, smoothing, and normalizing method as in \cite{Alex_flatfielding_2} for different subsets of the data separated by time of collection (or ``Batch''), and it was discovered that changing the lightbulb in the microscope between batches had a significant effect on the pattern of illumination variation, as shown in \reffig{fig:third_flatfielding}. 

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{images/introduction/third_flatfield_differences}
\caption{\footnotesize Differences in the third unmixed image layer between the normalized mean images computed independently for each batch and the original flatfield correction image measured in \cite{Alex_flatfielding_2} using a subset of the Batch3 data. These images showed that the illumination variations changed between batches, and especially for batches 12 and 13-14, before the collection of which the lightbulb in the microscope was replaced. Figures from \cite{Ben_flatfielding_1}.}
\label{fig:third_flatfielding}
\end{figure}

At this point the decision was made to measure and correct for the illumination variations independently for each batch of images collected. The work documented in \cite{Ben_flatfielding_1} also gave the first look at the illumination variations in samples collected with the Vectra Polaris imaging system as opposed to the Vectra 3.0 digital microscope, showing that the overall amount of variation was less for the Vectra Polaris, and the patterns were different in shape, likely due to the Vectra Polaris using an LED array rather than a lightbulb for slide illumination. This comparison was made in greater detail in \cite{Ben_flatfielding_2} where two component-layer mean image models were computed from sets of 10,000 HPFs collected with the Vectra 3.0 and Vectra Polaris microscopes. The corrections were applied to sets of 10,000 independent HPF datasets from each microscope, and the uncorrected and corrected images were unmixed using inForm and their own average images were compared. It was discovered that applying the flatfield corrections greatly reduced the overall illumination variation in the average unmixed images for both the Vectra 3.0 and Vectra Polaris microscopes, as shown in \reffig{fig:fourth_flatfielding}. To date this type of model of the average of large sets of images is used for correcting illumination variation before unmixing.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{images/introduction/fourth_flatfield_impact}
\caption{\footnotesize 10th and 90th percentile illumination flux relative to the layer mean in smoothed, unmixed average images before and after application of flatfielding corrections for data collected with the Vectra 3.0 and Vectra Polaris microscopes. The flatfielding corrections and the averages of the images to which they were applied were determined using independent sets of 10,000 HPFs each. Applying flatfield corrections of this type of smoothed, normalized, mean image layers reduced the overall illumination variation observed for images from both microscopes. Figures from \cite{Ben_flatfielding_1}.}
\label{fig:fourth_flatfielding}
\end{figure}

%%%%%%%%%%% This work subsection
\subsection{This work}
\label{ssec:this_work}

It is the goal of the work documented in this note to provide the most detailed and highest quality measurements of the illumination variation and associated flatfield corrections yet made by the Astropath group. To this end, an additional step has been implemented in the flatfielding procedure to only average over regions of images that are determined to show tissue, since the inclusion of empty background regions in many of the images over which the average is taken may bias measurements away from noise specifically affecting the tissue used for quantitative clinical pathology further down the line. A secondary goal of this work is to re-implement the analysis pipeline in python, an open-source programming language, and to develop a single software package that is not only easy to use but also able to scale up to even higher throughput without complicating analysis or prohibitively increasing runtime.

The findings presented in this note were prepared using a total set of 45,384 HPFs from 46 individual slides of melanoma tissue samples collected with the Vectra 3.0 digital microscope. The raw images all had 35 layers, and each layer had a width of 1,344 pixels and a height of 1,004 pixels. The set of 45,384 images was randomly divided into two subsamples of 22,692 HPFs each; one subsample was used to produce the flatfield corrections themselves and the other subsample was used to measure the illumination variation before and after application of the flatfield corrections.

\refsec{sec:image_masking} below discusses the methods used to identify tissue and mask background out of the HPFs of each sample. \refsec{sec:measuring_flatfield_corrections} explains how images were stacked, averaged, and smoothed to produce measurements of the flatfield corrections. \refsec{sec:results} shows the resulting flatfield image layers and details how their application reduces illumination variation measured in the independent subsample. A brief summary is presented in \refsec{sec:summary}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% IMAGE MASKING SECTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Image Masking}
\label{sec:image_masking}

One of the main goals of this work was to ignore as much empty background as possible in the images used to measure the flatfield corrections. The background portions of the images are inherently illuminated differently than the fluorescent tissue, so including background may bias measurements away from what would be observed for the tissue alone. The flatfield corrections should account only for the variations in tissue illumination because the tissue is what is used for clinical analysis. The separation of tissue from background was achieved using a masking procedure.

%%%%%%%%%%% Determining background flux thresholds subsection
\subsection{Determining background flux thresholds}
\label{ssec:determining_background_flux_thresholds}

The first step in masking background out of images is to find flux thresholds above which a pixel is more likely to represent bright tissue than dim background. Because of differences in staining, illumination, and fluorescence, these background flux thresholds were measured independently for each layer of each sample. A clear threshold is easiest to determine when a given image layer shows both some tissue and some background, which is often not the case in the bulk of the tissue samples, so thresholds were determined using HPFs located on the edges of each sample. The locations of these edge HPFs are shown in \reffig{fig:edge_HPFs} for a few examples. A set of optimal flux thresholds per layer is found for each of these images independently, and a final determination for the optimal layer thresholds for each sample as a whole is then made from these individual measurements.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.95\textwidth]{images/masking/rectangle_locations_M3_1}
\includegraphics[width=0.95\textwidth]{images/masking/rectangle_locations_M17_1}
\includegraphics[width=0.95\textwidth]{images/masking/rectangle_locations_M47_1}
\caption{\footnotesize Locations of HPFs on edges of tissue (left column) next to low-resolution reference .qptiff images (right column) for samples named M3\_1 (upper row), M17\_1 (middle row), and M47\_1 (lower row). }
\label{fig:edge_HPFs}
\end{figure}

Let each raw tissue edge HPF image be represented by a three-dimensional tensor $I_{i,j,m}$ whose $x$, $y$, and layer coordinates are indexed by $i=0,\ldots,w-1$, $j=0,\ldots,l-1$, and $m=0,\ldots,n-1$, respectively (where $w$, $l$, and $n$ are the width and length of the image in pixels and the number of image layers, respectively), and whose contents are pixel intensity fluxes. The initial image layers are first smoothed with a Gaussian filter\footnote{In all filtering operations described in this note, the values at edges of images are repeated to provide the necessary kernel extensions.} of standard deviation $\sigma=5$ pixels using the OpenCV computer vision library \cite{opencv_library} to remove small-scale variations in pixel content, producing a set of smoothed image layers $S_{i,j,m}$. The layers of $S$ are then collapsed into histograms $H_{m}(f)$ where $f$ is the discrete pixel intensity flux (from 0 to $F=65,535$ for 16-bit unsigned integers). \reffig{fig:raw_to_smoothed_to_histogram} shows $I_{i,j,0}$ and $S_{i,j,0}$ stretched from minimum to maximum in grayscale and the $H_{0}$ histogram for the first layer of a single HPF on the edge of the tissue in the sample called M21\_1. 

\begin{figure}[!ht]
\centering
\includegraphics[width=0.45\textwidth]{images/masking/example_raw_image}
\includegraphics[width=0.45\textwidth]{images/masking/example_smoothed_image}
\includegraphics[width=0.45\textwidth]{images/masking/example_histogram}
\caption{\footnotesize Raw image $I_{i,j,0}$ (upper left), smoothed image $S_{i,j,0}$ (upper right), and pixel intensity histogram $H_{0}$ (lower) for the first layer of an example tissue-edge HPF in the sample named M21\_1. (Note that the histogram is shown with a logarithmic y-axis.)}
\label{fig:raw_to_smoothed_to_histogram}
\end{figure}

The background pixels appear as peaks near the low edge of the $H_{m}(f)$ histograms: finding a threshold above which pixels are likely to show tissue amounts to finding the end of that low peak. To this end we employ Otsu's thresholding algorithm \cite{4310076}, which determines the threshold $T^{0}_{m}$ that maximizes the inter-class variance $\sigma^2(t)$ as a function of the threshold $t$ separating the signal and background classes in each $H_{m}(f)$,
\begin{equation}
T^{0}_{m} = \argmax{ \left\{ \sigma^2(t) \right\} } = \argmax{ \left\{ w_{b}(t) w_{s}(t) \left[ \frac{\sum_{f=0}^{t-1} f H_{m}(f)}{w_{b}(t)} - \frac{\sum_{f=t}^{F-1} f H_{m}(f)}{w_{s}(t)} \right]^2 \right\} },
\label{eq:otsu_threshold_def}
\end{equation}  
where $w_{b}(t) = \sum_{f=0}^{t-1} H_{m}(f)$ and $w_{s}(t) = \sum_{f=t}^{F-1} H_{m}(f)$ are variance weights for the background and signal classes, respectively.

We apply this algorithm iteratively to each $H_{m}(f)$ to find $K$ points of separation $T^{0}_{m}, \ldots, T^{K-1}_{m}$ between different categories of pixel intensities. Each successive $T^{k+1}_{m}$ is defined as the result of applying \refeq{eq:otsu_threshold_def} to the subset of $H_{m}(f)$ bounded above by the previous threshold $T^{k}_{m}$, where summations to $F-1$ in \refeq{eq:otsu_threshold_def} are replaced by summations to $T^{k}_{m}$ for each $k=0,\ldots,K-1$. Iteration continues until no more pixels are left with flux $f<T^{K+1}_{m}$, so the value of $K$ varies for each $H_{m}$.

We define a background pixel flux distribution $B_{m}(t)$ as the subset of $H_{m}$ that is bounded above by the flux $t$, and we define the population skew (or third standardized moment) of $B_{m}(t)$ as $\widetilde{\mu}_{m}(t)$. The optimal background threshold flux $\tau_{m}$ for a given $H_{m}$ is then chosen as the member of the Otsu threshold set exhibiting the maximal value of the local slope of the $\widetilde{\mu}_{m}(t)$ function weighted by $\widetilde{\mu}_{m}(t)$, like
\begin{equation}
\tau_{m} = \argmax{\left[ \xi(k) \right]} = \argmax{ \left[ \frac{ \widetilde{\mu}_{m}(T^{k}_{m}+1) - \widetilde{\mu}_{m}(T^{k}_{m}-1) }{ 2 \widetilde{\mu}_{m}(T^{k}_{m}) } \right] } .
\label{eq:otsu_choice_def}
\end{equation}

This method tends to choose thresholds resulting in $B_{m}(\tau_{m})$ with large local $\widetilde{\mu}_{m}$ slopes and small values of $\widetilde{\mu}_{m}(\tau_{m})$, indicating a left-weighted peak near $\tau_{m}$ that is relatively clustered around a single mean value, as would be expected for approximately-Gaussian background noise at the low end of $H_{m}$. \reffig{fig:histograms_with_otsu_thresholds} shows the thresholds $T^{k}_{m}$ overlaid on partial pixel intensity histograms for several $H_{m}$ distributions from the example dataset named M21\_1, as well as their corresponding $\widetilde{\mu}_{m}(T^{k}_{m})$ values and weighted and unweighted local $\widetilde{\mu}_{m}(t)$ slopes. It can be seen that the choice defined by \refeq{eq:otsu_choice_def} usually selects a $B_{m}(\tau_{m})$ that is, visually, the lowest peak in $H_{m}$.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.85\textwidth]{images/masking/thresholds_image_15_layer_1}
\includegraphics[width=0.85\textwidth]{images/masking/thresholds_image_11_layer_5}
\includegraphics[width=0.85\textwidth]{images/masking/thresholds_image_4_layer_27}
\includegraphics[width=0.85\textwidth]{images/masking/thresholds_image_25_layer_34}
\caption{\footnotesize Partial $H_{m}$ histograms with $T^{k}_{m}$ thresholds overlaid (left column), $\widetilde{\mu}_{m}(T^{k}_{m})$ values (middle column), and $0.5*\left[\widetilde{\mu}_{m}(T^{k}_{m}+1) - \widetilde{\mu}_{m}(T^{k}_{m}-1)\right]$ and $\xi(k)$ values (right column), for the 1st, 5th, 27th, and 34th layers of the 16th, 12th, 5th, and 26th tissue edge HPFs in the sample named M21\_1 (rows upper to lower, respectively).}
\label{fig:histograms_with_otsu_thresholds}
\end{figure}

For each sample, a final background threshold $\Tau_{m}$ per layer is chosen as the median of the $\tau_{m}$ values found for each tissue edge HPF. Taking the median of multiple measurements reduces the influence of outlier images in the sample, such as those that don't show a substantial portion of background, or that are unevenly stained and fluoresce more brightly than tissue in the bulk of the sample. Figures~\ref{fig:threshold_distributions_1} and ~\ref{fig:threshold_distributions_2} show the distributions of $\tau_{m}$ values observed in several layers and example samples, next to the sum of the $B_{m}(\tau_{m})$ histograms for all edge HPFs in the sample. The thresholding method used produces fairly regular distributions of the final background pixel flux distributions. \reffig{fig:all_sample_thresholds} shows severals statistics describing the $\Tau_{m}$ values found for all 46 of the Vectra 3.0 microscope samples analyzed; there is clear dependence on the broadband filter region, and there is nonzero but regular variation amongst the values found for each layer of the samples.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/masking/M1_1_layer_1_background_threshold_plots}
\includegraphics[width=0.80\textwidth]{images/masking/M3_1_layer_5_background_threshold_plots}
\includegraphics[width=0.80\textwidth]{images/masking/M4_2_layer_11_background_threshold_plots}
\caption{\footnotesize Distribution of $\tau_{m}$ values (left column) and summed $B_{m}(\tau_{m})$ histograms (right column) for all tissue edge HPFs in the 1st layer of the sample named M1\_1 (upper row), 5th layer of the sample named M3\_1 (middle row), and 11th layer of the sample named M4\_2 (lower row).}
\label{fig:threshold_distributions_1}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/masking/M6_1_layer_20_background_threshold_plots}
\includegraphics[width=0.80\textwidth]{images/masking/M10_2_layer_27_background_threshold_plots}
\includegraphics[width=0.80\textwidth]{images/masking/M11_1_layer_34_background_threshold_plots}
\caption{\footnotesize Distribution of $\tau_{m}$ values (left column) and summed $B_{m}(\tau_{m})$ histograms (right column) for all tissue edge HPFs in the 20th layer of the sample named M6\_1 (upper row), 27th layer of the sample named M10\_2 (middle row), and 34th layer of the sample named M11\_1 (lower row).}
\label{fig:threshold_distributions_2}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{images/masking/optimal_background_thresholds_batches_3-9_samples}
\caption{\footnotesize Maximum, minimum, 10th percentile, 90th percentile, median, mean, and standard deviation of $\Tau_{m}$ values determined from tissue edge HPFs for 46 Vectra 3.0 melanoma samples.}
\label{fig:all_sample_thresholds}
\end{figure}

%%%%%%%%%%% Producing image masks subsection
\subsection{Producing image masks}
\label{ssec:producing_image_masks}

The $\Tau_{m}$ values found for each sample can be used to mask background pixels out of arbitrary images from the same sample, layer-by-layer. Given a smoothed raw image $S_{i,j,m}$, and initial binary mask $M^{0}_{i,j,m}$ can be defined by a simple threshold at $\Tau_{m}$ as
\begin{equation}
M^{0}_{i,j,m} = 
\begin{cases} 
      0 & S_{i,j,m} \leq \Tau_{m} \\
      1 & S_{i,j,m} > \Tau_{m} 
\end{cases}
 .
\end{equation}
Multiplying an image by this binary mask will effectively remove regions that are not bright enough to be identified as background.

The smoothed image (as opposed to the raw image) is used to reduce the granularity of this initial mask, but the binary thresholding alone is not sufficient to produce a mask that uniformly describes bulk tissue regions of images. The initial $M^{0}_{i,j,m}$ masks are therefore transformed using image morphological operations \cite{opencv_mt} to produce larger and less isolated regions of identified signal and background. The operations used are of the ``open'' and ``close'' types, which are themselves compositions of ``erosion'' and ``dilation'' operations. An ``open'' operation is an erosion followed by a dilation, both with the same structure element, and a ``close'' is the opposite, a dilation followed by an erosion with the same structure element.

The exact operations performed on the initial mask $M^{0}_{i,j,m}$ are as follows. The mask image is first closed and then opened with an elliptical structure element of extent $9 \times 9$ pixels to fill in small holes that are surrounded by larger areas and remove any small, isolated areas. Another close and open is then performed with an elliptical element of size $16 \times 16$ pixels to serve the same purpose on a medium scale. The overall bulk of the mask is then defined by a single close operation with an elliptical element of size $45 \times 45$ pixels, and the edges of this bulk are refined, and small areas outside of it are removed, by opening three times with the $9 \times 9$ pixel structure element, to produce the final binary mask $M_{i,j,m}$. This sequence of operations is pictured in \reffig{fig:morphological_transformations} for an example image layer. 

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/masking/image_286_layer_9_masks}
\caption{\footnotesize Example application of morphological transformations used to refine initial binary masks. Image shown is from layer 9 of the sample named M14\_1. The raw image stretched from maximum to minimum in grayscale is shown in the upper left, and the initial mask layer $M^{0}_{i,j,8}$ from thresholding at $f=48$ is shown in the upper right. The results of applying the small-scale (left) and medium-scale (right) close and open operations are shown in the second row. The result of a single large-scale close is shown in the left column of the third row. The final mask after the repeated small-scale open is shown in the right column of the third row. The lower row shows the final transformed mask overlaid with (left) the raw image with flux clipped at $f=255$ to show the background more brightly in red, and (right) the raw image in grayscale.}
\label{fig:morphological_transformations}
\end{figure}

To further illustrate the masking procedure and the wide variation in the initial thresholds required, three more examples of how initial masks are transformed are shown in Figures~\ref{fig:mask_example_min}, \ref{fig:mask_example_med}, and~\ref{fig:mask_example_max} for image layers whose initial thresholds represent the global minimum, median, and maximum of the values shown in \reffig{fig:all_sample_thresholds}. Transforming the initial masks in this way tends to result in masks made of a minimal number of maximally-connected regions that correllate well with the tissue in each image, including smaller-scale features of the bulk but removing them from more isolated areas. The transformations described are performed for all image layers simultaneously on a GPU to maximize efficiency. 

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/masking/image_110_layer_26_masks}
\caption{\footnotesize Example application of morphological transformations used to refine initial binary masks. Image shown is from layer 26 of the sample named M11\_1. The raw image stretched from maximum to minimum in grayscale is shown in the upper left, and the initial mask layer $M^{0}_{i,j,8}$ from thresholding at $f=26$ is shown in the upper right. The results of applying the small-scale (left) and medium-scale (right) close and open operations are shown in the second row. The result of a single large-scale close is shown in the left column of the third row. The final mask after the repeated small-scale open is shown in the right column of the third row. The lower row shows the final transformed mask overlaid with (left) the raw image with flux clipped at $f=255$ to show the background more brightly in red, and (right) the raw image in grayscale.}
\label{fig:mask_example_min}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/masking/image_6455_layer_29_masks}
\caption{\footnotesize Example application of morphological transformations used to refine initial binary masks. Image shown is from layer 29 of the sample named M43\_1. The raw image stretched from maximum to minimum in grayscale is shown in the upper left, and the initial mask layer $M^{0}_{i,j,8}$ from thresholding at $f=41$ is shown in the upper right. The results of applying the small-scale (left) and medium-scale (right) close and open operations are shown in the second row. The result of a single large-scale close is shown in the left column of the third row. The final mask after the repeated small-scale open is shown in the right column of the third row. The lower row shows the final transformed mask overlaid with (left) the raw image with flux clipped at $f=255$ to show the background more brightly in red, and (right) the raw image in grayscale.}
\label{fig:mask_example_med}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/masking/image_9941_layer_5_masks}
\caption{\footnotesize Example application of morphological transformations used to refine initial binary masks. Image shown is from layer 5 of the sample named M9\_1. The raw image stretched from maximum to minimum in grayscale is shown in the upper left, and the initial mask layer $M^{0}_{i,j,8}$ from thresholding at $f=206$ is shown in the upper right. The results of applying the small-scale (left) and medium-scale (right) close and open operations are shown in the second row. The result of a single large-scale close is shown in the left column of the third row. The final mask after the repeated small-scale open is shown in the right column of the third row. The lower row shows the final transformed mask overlaid with (left) the raw image with flux clipped at $f=255$ to show the background more brightly in red, and (right) the raw image in grayscale.}
\label{fig:mask_example_max}
\end{figure}

\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% MEASURING FLATFIELD CORRECTIONS SECTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Measuring Flatfield Corrections}
\label{sec:measuring_flatfield_corrections}

The illumination variation is measured using only a subset of all the HPF images in a sample to make the highest quality estimation of the effects in the fluorescent tissue alone. First, any images located on the edges of tissue (like those pictured in red in the left column of \reffig{fig:edge_HPFs}) are excluded. Also excluded are any image layers whose masks select less than 80\% of the total pixels (that is, $\sum_{i=0}^{w-1}\sum_{j=0}^{l-1}M_{i,j,m}<0.8*(w*l)$) so that only images primarily showing tissue are stacked. This cut on the fraction of selected pixels reduces the phenomenon of overselecting noise in systematically brightly-illuminated regions of otherwise largely empty HPFs. The fraction of 80\% was chosen because it introduces only minimal bias to the variation in the number or location of the images that are stacked in each layer, as shown in Figures~\ref{fig:selected_pixel_fraction_cut_1} and~\ref{fig:selected_pixel_fraction_cut_2}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.45\textwidth]{images/measuring_flatfield_corrections/example_mask_stack_layer_1_cut_at_0_00}
\includegraphics[width=0.45\textwidth]{images/measuring_flatfield_corrections/example_mask_stack_layer_1_cut_at_0_20}
\includegraphics[width=0.45\textwidth]{images/measuring_flatfield_corrections/example_mask_stack_layer_1_cut_at_0_50}
\includegraphics[width=0.45\textwidth]{images/measuring_flatfield_corrections/example_mask_stack_layer_1_cut_at_0_80}
\caption{\footnotesize Numbers of masks selected to be stacked at each location in the first image layer, with the required fraction of selected pixels at 0\% (no cut, upper left), 20\% (upper right), 50\% (middle left), and 80\% (middle right). With no requirement on the selected pixel fraction, a systematic bias to the lower right hand corner of the images is observed due to overselection of relatively brighter noise in otherwise empty HPFs. This bias persists with the cut at 20\%, and a different systematic bias toward the image centers is observed with the cut at 50\%. The cut at 80\% is the smallest value of the cut that shows less bias to any region. Figures shown were all produced using a set of 6,309 total initial HPFs from 11 Vectra 3.0 samples named M6\_1, M3\_1, M17\_1, M29\_1, M16\_1, M35\_1, M25\_1, M36\_1, M52\_1, M21\_1, and M14\_1.}
\label{fig:selected_pixel_fraction_cut_1}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/measuring_flatfield_corrections/example_mask_stack_spreads_by_layer}
\caption{\footnotesize Difference between the maximum and minimum numbers of images selected to be stacked at any location within each image layer at different values of the selected pixel fraction requirement, divided by the spread observed with no cut applied. The line representing the cut at 80\% is the first that does not increase the spread from what is initially observed. Figure produced using a set of 6,309 total initial HPFs from 11 Vectra 3.0 samples named M6\_1, M3\_1, M17\_1, M29\_1, M16\_1, M35\_1, M25\_1, M36\_1, M52\_1, M21\_1, and M14\_1.}
\label{fig:selected_pixel_fraction_cut_2}
\end{figure} 

These requirements on the images and their masked layers define a total number of HPFs from all samples to be stacked in each layer, $N_{m}$. \reffig{fig:n_images_stacked_by_layer} shows this $N_{m}$ for the total set of Vectra 3.0 samples used to make the flatfield correction image, which consists of 22,692 initial HPFs, reduced to 19,024 HPFs after removing those on the edges of the tissue. 

\begin{figure}[!ht]
\centering
\includegraphics[width=0.80\textwidth]{images/measuring_flatfield_corrections/n_images_stacked_per_layer}
\caption{\footnotesize Number of images $N_{m}$ selected to be stacked in each layer for the set of 22,692 initial HPFs from 46 Vectra 3.0 samples.}
\label{fig:n_images_stacked_by_layer}
\end{figure} 

The layers of the previously-defined image and mask tensors $I$ and $M$ can be collected over the whole image layer set using a new index $\eta=0,\ldots,N_{m}-1$. The sum of all the mask layers, $\Mu_{i,j,m} = \sum_{\eta=0}^{N_{m}-1} M^{\eta}_{i,j,m}$ is shown in \reffig{fig:mask_stack_layers} for the first, middle, and last layers in each broadband filter region. A small bias toward selecting the lower right hand corners of the images remains in most cases. 

\begin{figure}[!ht]
\centering
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_1}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_5}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_9}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_10}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_14}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_18}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_19}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_22}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_25}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_26}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_29}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_32}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_33}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_34}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/mask_stack_layers/mask_stack_layer_35}
\caption{\footnotesize Layers of the total stack of binary image masks, $\Mu_{i,j,m}$, for $m=$0, 4, 8, 9, 13, 17, 28, 21, 24, 25, 28, 31, 32, 33, and 34 from upper left to lower right, respectively. Note the differences in scales for each image.}
\label{fig:mask_stack_layers}
\end{figure}

Only the central 64\% of each fully-corrected HPF is used when pathology analyses are eventually performed, because the outer 20\% of each image's sides are used to determine the alignment and stitching of the individual HPFs to represent an entire sample \cite{Heshy}. Clipping 10\% from all sides of the image layers (so that $i=0.1*w,\ldots,0.9*w$ and $j=0.1*l,\ldots,0.9*l$) also removes the edge effects apparent in $\Mu_{i,j,m}$. \reffig{fig:clipped_mask_stack_layers} shows the same as \reffig{fig:mask_stack_layers}, except with 10\% of each side of each image layer removed, and \reffig{fig:removing_image_edges_effect_on_mask_stacks} shows how the maximum, minimum, 5th and 95th percentile, and standard deviation of the number of masks stacked in each layer relative to the layer mean changes when the outer 36\% of the image layers are removed. The spread from the 5th to 95th percentile of the number of images stacked divided by the layer mean decreases from 11.2\% to 1.2\% on average over all layers, and the standard deviation of the number of images stacked divided by the layer mean decreases from 0.72\% to 0.49\% on average over all layers, showing that the masking and image layer selection procedures ultimately result in only very small differences in how many images contribute to measurements of the illumination variation in the region of interest.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_1}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_5}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_9}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_10}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_14}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_18}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_19}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_22}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_25}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_26}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_29}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_32}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_33}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_34}
\includegraphics[width=0.3\textwidth]{images/measuring_flatfield_corrections/clipped_mask_stack_layers/clipped_mask_stack_layer_35}
\caption{\footnotesize Central 64\% of layers of the total stack of binary image masks $\Mu_{i,j,m}$ for $m=$0, 4, 8, 9, 13, 17, 28, 21, 24, 25, 28, 31, 32, 33, and 34 from upper left to lower right, respectively. Image scales are identical to those in \reffig{fig:mask_stack_layers} to show reduction in variation.}
\label{fig:clipped_mask_stack_layers}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.90\textwidth]{images/measuring_flatfield_corrections/mask_stack_variation_reduction}
\caption{\footnotesize Maximum, minimum, 5th and 95th percentile, and standard deviation of the number of images stacked relative to the mean in each layer computed using the full images (red lines and green shading) and only the central 64\% of interest (blue lines and orange shading). The relative variation in the number of images stacked is smaller in the central region of interest.}
\label{fig:removing_image_edges_effect_on_mask_stacks}
\end{figure} 

An initial mean image $\Iota_{i,j,m}$ is defined pixel-by-pixel by summing over all masked raw images and dividing by the number of images stacked, like
\begin{equation}
\Iota_{i,j,m} = \frac{1}{\Mu_{i,j,m}} \left[ \sum_{\eta=0}^{N_{m}-1} I^{\eta}_{i,j,m}*M^{\eta}_{i,j,m} \right] .
\end{equation}
Each layer of $\Iota$ is then smoothed using a wide Gaussian filter of standard deviation $\sigma=100$ pixels to produce a smoothed mean image $G_{i,j,m}$ that describes only the large-scale variations. The final flatfield image $F_{i,j,m}$, whose contents are the pixel-by-pixel correction factors, is this $G$ image, with each layer normalized by its mean,
\begin{equation}
F_{i,j,m} = G_{i,j,m} \left( \frac{w*l}{\sum_{i=0}^{w-1}\sum_{j=0}^{l-1}G_{i,j,m}} \right) ,
\end{equation}
so that applying the corrections only changes the relative illumination within each layer. 

\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% RESULTS SECTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}
\label{sec:results}

The flatfield image $F$ describes the systematic variations in the amount of illumination observed in the regions of HPF images showing fluorescent tissue. Applying the correction factors the $F$ image contains is shown to decrease the amount of illumination variation observed over a large and independent sample of identically masked and selected HPFs. The addition of image layer masking and selection is shown to improve the reduction in illumination variation over the original methods where no masking or selection are applied.

%%%%%%%%%%% Flatfield images subsection
\subsection{Flatfield images}
\label{ssec:flatfield_images}

%%%%%%%%%%% Reduction in illumination variation subsection
\subsection{Reduction in illumination variation}
\label{ssec:reduction_in_illumination_variation}

%%%%%%%%%%% Impact of masking subsection
\subsection{Impact of masking}
\label{ssec:impact_of_masking}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SUMMARY SECTION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Summary}
\label{sec:summary}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BIBLIOGRAPHY %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliography{references}

\end{document}