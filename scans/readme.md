# Section 3: Setting Up, Organization, and Scanning
## Section 3.1: Description
The AstroPath Pipeline requires that a number of experimental protocols are understood and followed for the code to work. These protocols include methods for slide scanning, slide naming, regent tracking, and directory organization. This section of the documentation describes these protocols and provides important definitions for terms used throughout the AstroPath Pipeline documentations. Additionally, there is a main directory, refered to as the ```<Mpath>```, which contains a set of csv files. These files contain pertinent information which drive processing such as directory locations, machine names, slide names, and project identifiers. These csv files are defined in [Section 3.4](#section-34-astropathprocessing-directory-and-initializing-projects "Title")

## Section 3.2 Definitions
### Section 3.2.1: Identification Definitions
- ```Method[String]```: This is the staining method. Either:
  - *Manual*: manually stained
  - *Automatic*: stained by an automatic stainer (E.g. *Lecia Bond Rx*)
- ```Panel[String]```: For each unique set of antibodies we have provided an idenitifying name.
   - E.g. *PD1\PDL1 Axis*. 
- ```Tissue[String]```: The tissue the panel was stained on
- ```Machine[string]```: The user defined name of the microscope the machine was scanned on. 
   - This specifier is used to find particular files needed for processing a of specified microscope, particularly the image warping parameters. 
   - Traditionally the microscopes are named with a three letter location specifier, followed by the machine type (Polaris, Vectra3), then underscore and a numeric value. (E.g. JHUVectra3_1).
- ```StainConfig[int]```: The stain configuration is a unique numeric value for a ```Machine, Method, Panel``` pairing. 
- ```Cohort[int]```: A unique numeric identifier for a set of patient samples. 
   - Cohorts can belong in multiple ```Projects``` if stained with different ```StainConfig```s.
- ```Project[int]```: Defined as a set of slides, or ```Cohort```, stained with a single ```Panel``` and ```Method``` then scanned by a single ```Machine```.
   - These values are unqiue and are defined at the start of processing then used throughout the code to identify that project. 
   - All data for a specified project should be placed in a single folder. 
- ```Batch[int]```: The unique numeric value for a batch of slides stained together. 
   - For each unique ```Project```, each set of ```BatchID```s are separate and usually starts over at 1. 
   - Additional details on ```BatchID```s can be found below in [Section 3.3](#section-33-scanning-verifying-complete-and-adding-batchids "Title").
- ```SampleName[string]```s: The ```SampleName```s are the names defined during the scanning process
   - These names are replaced and standarized as part of the pipeline. 
   - The code detects these from the *SpecimenTable.xlsx* files contained in each cohort scanning folder. 
   - A description of the *SpecimenTable.xlsx* file is in [Section 3.3](#section-33-scanning-verifying-complete-and-adding-batchids "Title") repository.
- ```SlideID[string]```s: The names for the specimens in the astropath processing pipeline 
   - These names replace the ```SampleName```s on all corresponding files and inside the scanning plan, annotations.xml, files generated during the scanning process.
   - Using these names allows us to avoid outside the organization changes to naming conventions.
   - The IDs have the format; ```APpppXXXX```
     - ```ppp``` indicates the numeric ```ProjectID```
     - ```XXXX``` is a slide number which is unique within a project
   - The IDs are generated by comparing the *AstropathAPIDdef_PP.csv* to the cohort specific *SpecimenTable.xlsx*
     - we assign each new specimen with a new value in sequential ordering (AP0010001, AP0010002, AP0020001 …) 
     
### Section 3.2.2: Path Definitions
The file path structures have been standarized and are described below.
- ```<Mpath>```: The main path for all the astropath processing *.csv* configuration files.
  - The current location of this path is ```\\bki04\astropath_processing```.
  - A description of each file is located below in [Section 3.4](#section-34-astropathprocessing-directory-and-initializing-projects "Title")
- ```<Dpath>```: The data or destination path up to the server folder.
  - this is the path to the project's data on the bki servers but does not include the ```<Dname>```
- ```<Dname>```: The data name or the name of the clinical specimen folder. 
   - All data for a project should be located inside this folder. 
   - Usually this folder is shared over the network. 
   - This is only the folder name such that the full path to the data is ```\\<Dname>\<Dpath>```
   - E.g. “Clinical_Specimen_7” 
- ```<Spath>```: This is the full path for the source directory of the data
  - usually indicates a subdirectory on a server where the microscope is backed up to after scanning is complete.
  -  E.g. “\\tme1\VectraPolaris\Vectra Polaris 1 Scanning\Clinical_Specimen_7” 
- ```<Cpath>```: This is where compressed copies of the im3 image files and final Tables\ component data tiffs are stored after the pipeline has finished processing. 
  -	E.g. “bki03\Compressed_Clinical_Specimens”
  -	E.g. “bki03\Compressed_Clinical_Specimens_2”
- ```<FWpath>```: This is the path for the single column flat field and warping image (.fw) as well as the exposure time data for each image (.SpectralBasisInfo.xml). 
   - This path should preferably located on a different drive from the main path to improve pipeline performance. 
   - E.g. “bki03\flatw_7”
   - ***Additional details on these files can be found in the flatw workflow description***

*NOTE:* the ```<path>``` variables do not contain the ```<Dname>```

## Section 3.3: Scanning, Verifying Complete, and Adding BatchIDs
Before scanning it is important to set up the ```<spath>```. This folder is created on the scanning computer where slides are scanned into. The folders are usually labeled *Clinical_Specimen_N*, where the *N* indicates a numeric value or unique lettering. Examples of these scanning folders incude *Clinical_Specimen_2* and *CLinical_Specimen_BMS_01*. In the JHU processing pipeline, this folder is backed up every night to a network server with significant storage capacity (~80TB) using commercially available software. In this way once slide scans are completed they can be deleted from the computer in such a way that the computers never run in storage issues. *NOTE*: The fully qualified path for this scanning folder on the server is designated as the ```<spath>```. 

After new slides are stained, they should be added to a *Specimen_Table_N.xlsx* file located in each ```<spath>```, described in detail below in [Section 3.3.1](#section-331-specimentable “Title”). As part of adding slides to this table, the slides will be given a unique de identified name for scanning. Tips on these names are included in [Section 3.3.2](#section-332-samplenames-m-numbers “Title”). The most important aspect of this convention is to avoid the use of spaces and special characters. Once added to the *SpecimenTable.xlsx*, slides can be scanned with 20% overlap according to the protocol laid out in [Section 3.3.3](#section-333-whole-slide-scanning “Title”). In order for successful processing of the slides, it is very important that this procedure is adhered to correctly. After slides are scanned, the user should manually verify that all images were scanned completed properly and add a *BatchID.txt* file to the successful ```Scan``` directory. This initiates the slide transfer process in the pipeline, additional details on this step are defined in [Section 3.3.4](#section-334-batchids “Title”). It is also important to create the *Batch_BB.csv* and *MergeConfig_BB.csv* files for processing to continue successfully. Each staining batch defined should have a separate set of these tables. Information on these files can be found in [Section 3.3.5](#section-335-batch-tables “Title”) and [Section 3.3.6](#section-336-mergeconfig-tables “Title”), respectively. 

### Section 3.3.1 Specimen_Table
The specimen table is used to intialize the slides and servers as the link between the de identified slide ids and the clinical specimen ids. The specimen table should be labeled *Specimen_Table_N.xlsx*, where *N* stands for the same unique specifier on the *Clinical_Specimen_N* folder. This file should always be contained on a HIPAA complinant location. The file has the following columns:
```
Patient #, Specimen #, Cut Data, Level, Batch ID, Stain Date, Scan Date
```
- ```Patient #```: this is the ```SampleName``` defined in [Section 3.2.1](#section-321-identification-definitions "Title")
- ```Specimen #```: this the specimen number that is used to identify the patient clinical information
- ```Cut Date```: the date that the slide was cut from the tissue block
- ```Level```: the cut number from the sections cut on that date
- ```Batch ID```: the staining batch the slides was stained with, more details below in [Section 3.3.4](#section-334-batchids “Title”).
- ```Stain Date```: the date the slide was stained on 
- ```Scan Date```: the date the slide started HPF scanning

### Section 3.3.2 SampleNames (Patient # or M Numbers)


## Section 3.4: AstroPath_Processing Directory and Initializing Projects
The code is driven by the files located in a main processing folder, named the ```<Mpath>```. These files are described below followed by descriptions of the respectve columns. For columns without definitions provided, please check [Section 3.2](#section-32.definitions "Title") above. After a description of the directory and files included, instructions for intializing projects into the pipeline are provided.

### Section 3.4.1 AstroPath_Processing Directory
- *AstropathCohortsProgress.csv*: This file contains information on the project's analysis status and important experimental variables. This table is manually updated. The file has the following columns:
  ```
  Project, Cohort, Dpath, Dname, Machine, Method, Panel, Tissue, StainConfig, Stain, Scan, Inform, Merged, QC, Annotations, ReadyForDB, DBLoad
  ```
  - ```Stain[string]```: The staining status of the panel. Should be indicated as blank (not started), *Started*, or *Done*.
  - ```Inform[string]```: The status of the inform algorithm for classification and segmentation. Should be indicated as blank (not started), *Started*, or *Done*.
  - ```Merged[string]```: The status of the inform processing and merge. Should be indicated as blank (not started), *Started*, or *Done*.
  - ```QC[string]```: The status of the quality control assessment of samples. Should be indicated as blank (not started), *Started*, or *Done*.
  - ```Annotations[string]```: Whether or not the slide annotations have been created for a panel. ***Annotation directions can be found in***. Should be indicated as blank (not started), *Started*, or *Done*.
  - ```ReadyForDB[string]```: Indicates whether final checks for the manual interaction steps with the data have been complete. ***A full checklist is still in progress.***. Should be indicated as blank (not started), *Started*, or *Done*.
  - ```DBLoad```: The current status of the database load. Should be indicated as blank (not started), *Started*, or *Done*.
- *AstropathConfig.csv*
- *AstropathControldef.csv*
- *AstropathPaths.csv*
- *AstropathSampledef.csv*
- *AstropathAPIDdef.csv*
